# RingleBot (링글봇) - 모듈형 아키텍처

맥(Mac)의 아이메시지(iMessage)를 연동하여 동작하는 AI 영어 튜터 봇입니다.
FastAPI를 기반으로 리팩토링되었으며, 대화 맥락을 기억하고 자연스러운 영어 교정을 제공합니다.

## ✨ 주요 기능

*   **실시간 대화**: 아이메시지와 **SMS(문자)**를 모두 지원하며, 받은 방식 그대로 답장합니다.
*   **다중 레벨 메모리 시스템**: 
    *   **단기 메모리**: 최근 20개 메시지 (iMessage DB에서 실시간 로드)
    *   **중기 메모리**: 5개 메시지마다 자동 요약 생성 및 저장
    *   **장기 메모리**: 사용자 프로필 및 학습 데이터 (SQLite)
*   **스마트 응답 시스템**: 🎉 **NEW**
    *   **응답 중단**: 새 메시지 도착 시 이전 응답 자동 중단
    *   **우선순위 큐**: 최신 메시지 우선 처리
    *   **세션 관리**: 대화 흐름 추적 및 상태 관리
*   **지능형 메시지 분할**: 🎉 **NEW**
    *   짧은 응답(5단어 미만)은 분할 안함
    *   문단 경계, 목록, 화제 전환을 감지하여 의미 단위로 분할
    *   단일 기호/숫자 자동 병합
*   **언어 감지**: 한국어/영어 자동 감지 (한글 비율 30% 기준) 🎉 **NEW**
*   **문맥 인식 (Context Awareness)**: 이전 대화 요약을 기억하여 자연스러운 티키타카 가능
*   **최적화된 타이핑 속도**:
    *   메시지 길이에 따라 입력 시간을 조절 (평균 0.5-2초)
    *   긴 답변은 의미 단위로 끊어서 전송
    *   최대 지연 3초로 제한
*   **영어 교정**: 링글 튜터 페르소나(Emily)가 학생(Kwon)의 문법을 자연스럽게 교정
*   **자동 응답**: 받은 모든 메시지에 자동으로 응답합니다.

## 📂 프로젝트 구조

*   `main.py`: 메인 서버 & 메시지 감지 루프
*   `imessage/`: iMessage 연동
    *   `reader.py`: `chat.db` 읽기 (SMS/iMessage 구분)
    *   `sender.py`: AppleScript 발송
    *   `manager.py`: 메시지 대기열(Queue) 및 타이밍 관리
*   `ai/`: AI 기능
    *   `chat.py`: OpenAI API 연동
    *   `grammar.py`: 튜터 페르소나 정의
    *   `utils.py`: 메시지 분할 및 딜레이 계산 로직
*   `memory/`: 다중 레벨 메모리 시스템 🎉 **NEW**
    *   `summary.py`: 대화 요약 생성
    *   `storage.py`: SQLite 영구 저장
*   `state/`: 상태 관리
    *   `context.py`: 대화 맥락 및 메모리 관리
    *   `user.py`: 사용자 설정
*   `data/`: 데이터 저장
    *   `memory.db`: 대화 요약 및 사용자 프로필 DB

## 🛠️ 필수 조건

*   **macOS** (아이메시지 사용 가능 환경)
*   **Python 3.x**
*   **Full Disk Access**: 터미널/에디터에 `~/Library/Messages/chat.db` 접근 권한 필요

## 🚀 설치 및 실행

1.  **패키지 설치**:
    ```bash
    pip install openai python-dotenv fastapi uvicorn
    ```

2.  **환경 설정 (`.env`)**:
    프로젝트 루트에 `.env` 파일을 생성하세요.
    ```env
    OPENAI_API_KEY=sk-proj-....
    TARGET_PHONE_NUMBER=+821012345678
    ```

3.  **서버 실행**:
    ```bash
    python3 main.py
    ```

## 📝 최근 변경사항

### v0.4.0 - 스마트 응답 시스템 (2026-02-12) 🎉

#### 🚀 주요 개선
*   **응답 중단 기능**: 새 메시지 도착 시 이전 응답 자동 중단
    - 우선순위 큐(PriorityQueue) 구현
    - 세션 ID 기반 메시지 필터링
    - 대화 상태 추적 (IDLE/WAITING/BOT_RESPONDING)

*   **지능형 메시지 분할**: 의미 단위로 자연스럽게 분할
    - 짧은 응답(5단어 미만) 분할 안함
    - 문단, 목록, 화제 전환 감지
    - 단일 기호/숫자 자동 병합
    - 구조화된 내용(목록, 코드블록) 유지

*   **타이핑 속도 최적화**: 5초 → 3초 최대 지연
    - 평균 0.5-2초로 빠른 응답
    - 자연스러운 대화 흐름

*   **언어 감지**: 한국어/영어 자동 감지 (한글 비율 30% 기준)

#### 🐛 버그 수정
*   **대화 히스토리 복원**: 봇 응답이 히스토리에 누락되던 문제 수정
    - `get_conversation_history()` 쿼리 개선 (chat_message_join 사용)
    - 이제 봇 응답을 제대로 기억하고 대화 맥락 유지
    
*   **큐 블로킹 해결**: 응답 중단 시 큐가 막히던 문제 수정
    - 세션 ID 필터링으로 안전한 중단 구현
    - Race condition 방지

### v0.3.0 - 다중 레벨 메모리 시스템 (2026-02-12)
*   ✅ **자동 요약**: 5개 메시지마다 대화 내용 자동 요약
*   ✅ **영구 저장**: SQLite DB에 요약 및 핵심 포인트 저장
*   ✅ **맥락 유지**: 서버 재시작 후에도 이전 대화 맥락 기억
*   ✅ **사용자 프로필**: 학습 목표, 선호도 등 장기 데이터 저장

### v0.2.0 - 기본 기능 안정화 (2026-02-11)
*   ✅ **자체 메시지 필터링**: 봇이 자신이 보낸 메시지를 읽지 않도록 수정
*   ✅ **타이핑 시뮬레이션 제거**: 접근성 권한 문제로 인해 비활성화
*   ✅ **트리거 모드 제거**: 모든 메시지에 자동 응답
*   ✅ **서비스 타입 지원**: iMessage/SMS 구분 처리 개선

## 🧪 테스트

메모리 시스템을 테스트하려면:

```bash
python test_memory.py
```

이 스크립트는:
- 데이터베이스 초기화 확인
- 요약 저장/로드 테스트
- 사용자 프로필 저장/로드 테스트
- (선택) OpenAI 요약 생성 테스트

## ⚠️ 알려진 문제 (Known Issues)

*   **빈 메시지 처리**: 사진이나 이모티콘 등 텍스트가 없는 메시지는 자동으로 무시됩니다.
